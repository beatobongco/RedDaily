<!DOCTYPE html>
<html>
<head>
  <title>Your daily dose of less distracting reddit</title>
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
  <div class="app" id="app">
    <div class="category-container" v-for="category in categories" v-cloak>
      <div class="category" v-bind:class="[category]">
        <h3>{{ category }} </h3>
        <ol>
          <li class="post" v-for="post in db[category].posts.slice(0, db[category].showLimit)">
            <a class="title" :href="post.url">{{ post.title }}</a>
            <div class="info">
              <a class="comments" :href="post.permalink">comments ({{ post.comments }})</a>
              &middot;
              <span class="subreddit">{{ post.subreddit }}</span>
              &middot;
              <span class="created"> {{ moment(post.created, 'X').fromNow() }} </span>
            </div>
          </li>
        </ol>
        <a class="readmore" href="#" v-on:click="incrementLimit(category, $event)">read more</a>
      </div>
    </div>
  </div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.0.3/vue.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/superagent/2.3.0/superagent.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.16.4/lodash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
<script type="text/javascript">
  // - toggle daily, weekly, monthly
  // - accept subreddit to watch with validation
  var subredditMax = 3
  var items = []
  var db = {
    tech: {
      subreddits: ["programming", "futurology", "tech", "linux", "learnprogramming", "python", "javascript"],
      posts: [],
      showLimit: 5
    },
    design: {
      subreddits: ["design", "graphic_design", "web_design", "webdesignnews", "UserExperience", "DataIsBeautiful", "typography"],
      posts: [],
      showLimit: 5
    },
    sports: {
      subreddits: ["climbing", "bouldering", "climbingvids", "climbharder"],
      posts: [],
      showLimit: 5
    },
    trivia: {
      subreddits: ["IAmA", "books", "askhistorians", "explainlikeimfive", "LifeProTips", "lifehacks", "YouShouldKnow", "TrueReddit", "interestingasfuck"],
      posts: [],
      showLimit: 5
    }
  }

  function fixRedditLinks(link) {
    if (link.split('.')[1] === "reddituploads") {
      return link.replace(/&amp;/g, "&")
    }
    return link
  }

  var app = new Vue({
    el: '#app',
    data: {
      mode: "day",
      categories: ["tech", "design", "sports", "trivia"],
      db: db,
    },
    methods: {
      incrementLimit: function(category, e) {
        e.preventDefault()
        db[category].showLimit += 5
        if (db[category].showLimit >= db[category].posts.length) {
          e.target.style.display = "none"
        }
      },
      retrieveAll: function() {
        for (var i = 0; i < app.categories.length; i++) {
          app.retrievePosts(app.categories[i])
        }
      },
      retrievePosts: function(category) {
        var subreddits = db[category].subreddits
        for (var i = 0; i < subreddits.length; i++) {
          superagent
            .get("https://www.reddit.com/r/" + subreddits[i] + "/top/.json?t=" + app.mode)
            .end(function(e, r) {
              var posts = r.body.data.children.slice(0, subredditMax)
              for (var i = 0; i < posts.length; i++) {
                var data = posts[i].data

                //preprocess URL
                var url = data.url
                url = fixRedditLinks(url)

                var permalink = "https://www.reddit.com" + data.permalink
                db[category].posts.push({
                  title: data.title,
                  url: url,
                  score: data.score,
                  subreddit: data.subreddit,
                  permalink: permalink,
                  created: data.created_utc,
                  comments: data.num_comments
                })
              }
              db[category].posts = _.sortBy(db[category].posts, "score").reverse()
            })
        }
      },
    },
  })

  app.retrieveAll()

</script>
</body>
</html>
